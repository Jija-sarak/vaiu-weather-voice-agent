{"version":3,"sources":["../../src/voice/report.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport type { ChatContext } from '../llm/chat_context.js';\nimport type { VoiceOptions } from './agent_session.js';\nimport type { AgentEvent } from './events.js';\n\nexport interface SessionReport {\n  jobId: string;\n  roomId: string;\n  room: string;\n  options: VoiceOptions;\n  events: AgentEvent[];\n  chatHistory: ChatContext;\n  enableUserDataTraining: boolean;\n  timestamp: number;\n}\n\nexport interface SessionReportOptions {\n  jobId: string;\n  roomId: string;\n  room: string;\n  options: VoiceOptions;\n  events: AgentEvent[];\n  chatHistory: ChatContext;\n  enableUserDataTraining?: boolean;\n  timestamp?: number;\n}\n\nexport function createSessionReport(opts: SessionReportOptions): SessionReport {\n  return {\n    jobId: opts.jobId,\n    roomId: opts.roomId,\n    room: opts.room,\n    options: opts.options,\n    events: opts.events,\n    chatHistory: opts.chatHistory,\n    enableUserDataTraining: opts.enableUserDataTraining ?? false,\n    timestamp: opts.timestamp ?? Date.now(),\n  };\n}\n\n// TODO(brian): PR5 - Add uploadSessionReport() function that creates multipart form with:\n//   - header: protobuf MetricsRecordingHeader (room_id, duration, start_time)\n//   - chat_history: JSON serialized chat history (use sessionReportToJSON)\n//   - audio: audio recording file if available (ogg format)\n//   - Uploads to LiveKit Cloud observability endpoint with JWT auth\nexport function sessionReportToJSON(report: SessionReport): Record<string, unknown> {\n  const events: Record<string, unknown>[] = [];\n\n  for (const event of report.events) {\n    if (event.type === 'metrics_collected') {\n      continue; // metrics are too noisy, Cloud is using the chat_history as the source of truth\n    }\n\n    events.push({ ...event });\n  }\n\n  return {\n    job_id: report.jobId,\n    room_id: report.roomId,\n    room: report.room,\n    events,\n    options: {\n      allow_interruptions: report.options.allowInterruptions,\n      discard_audio_if_uninterruptible: report.options.discardAudioIfUninterruptible,\n      min_interruption_duration: report.options.minInterruptionDuration,\n      min_interruption_words: report.options.minInterruptionWords,\n      min_endpointing_delay: report.options.minEndpointingDelay,\n      max_endpointing_delay: report.options.maxEndpointingDelay,\n      max_tool_steps: report.options.maxToolSteps,\n    },\n    chat_history: report.chatHistory.toJSON({ excludeTimestamp: false }),\n    enable_user_data_training: report.enableUserDataTraining,\n    timestamp: report.timestamp,\n  };\n}\n"],"mappings":"AA6BO,SAAS,oBAAoB,MAA2C;AAC7E,SAAO;AAAA,IACL,OAAO,KAAK;AAAA,IACZ,QAAQ,KAAK;AAAA,IACb,MAAM,KAAK;AAAA,IACX,SAAS,KAAK;AAAA,IACd,QAAQ,KAAK;AAAA,IACb,aAAa,KAAK;AAAA,IAClB,wBAAwB,KAAK,0BAA0B;AAAA,IACvD,WAAW,KAAK,aAAa,KAAK,IAAI;AAAA,EACxC;AACF;AAOO,SAAS,oBAAoB,QAAgD;AAClF,QAAM,SAAoC,CAAC;AAE3C,aAAW,SAAS,OAAO,QAAQ;AACjC,QAAI,MAAM,SAAS,qBAAqB;AACtC;AAAA,IACF;AAEA,WAAO,KAAK,EAAE,GAAG,MAAM,CAAC;AAAA,EAC1B;AAEA,SAAO;AAAA,IACL,QAAQ,OAAO;AAAA,IACf,SAAS,OAAO;AAAA,IAChB,MAAM,OAAO;AAAA,IACb;AAAA,IACA,SAAS;AAAA,MACP,qBAAqB,OAAO,QAAQ;AAAA,MACpC,kCAAkC,OAAO,QAAQ;AAAA,MACjD,2BAA2B,OAAO,QAAQ;AAAA,MAC1C,wBAAwB,OAAO,QAAQ;AAAA,MACvC,uBAAuB,OAAO,QAAQ;AAAA,MACtC,uBAAuB,OAAO,QAAQ;AAAA,MACtC,gBAAgB,OAAO,QAAQ;AAAA,IACjC;AAAA,IACA,cAAc,OAAO,YAAY,OAAO,EAAE,kBAAkB,MAAM,CAAC;AAAA,IACnE,2BAA2B,OAAO;AAAA,IAClC,WAAW,OAAO;AAAA,EACpB;AACF;","names":[]}