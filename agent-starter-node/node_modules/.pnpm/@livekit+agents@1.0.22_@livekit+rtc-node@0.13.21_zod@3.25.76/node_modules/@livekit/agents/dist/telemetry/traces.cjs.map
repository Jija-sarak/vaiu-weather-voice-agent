{"version":3,"sources":["../../src/telemetry/traces.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport {\n  type Attributes,\n  type Context,\n  type Span,\n  type SpanOptions,\n  type Tracer,\n  type TracerProvider,\n  context as otelContext,\n  trace,\n} from '@opentelemetry/api';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';\nimport { CompressionAlgorithm } from '@opentelemetry/otlp-exporter-base';\nimport { Resource } from '@opentelemetry/resources';\nimport type { ReadableSpan, SpanProcessor } from '@opentelemetry/sdk-trace-base';\nimport { BatchSpanProcessor, NodeTracerProvider } from '@opentelemetry/sdk-trace-node';\nimport { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions';\nimport { AccessToken } from 'livekit-server-sdk';\n\nexport interface StartSpanOptions {\n  /** Name of the span */\n  name: string;\n  /** Optional parent context to use for this span */\n  context?: Context;\n  /** Attributes to set on the span when it starts */\n  attributes?: Attributes;\n  /** Whether to end the span when the function exits (default: true) */\n  endOnExit?: boolean;\n}\n\n/**\n * A dynamic tracer that allows the tracer provider to be changed at runtime.\n */\nclass DynamicTracer {\n  private tracerProvider: TracerProvider;\n  private tracer: Tracer;\n  private readonly instrumentingModuleName: string;\n\n  constructor(instrumentingModuleName: string) {\n    this.instrumentingModuleName = instrumentingModuleName;\n    this.tracerProvider = trace.getTracerProvider();\n    this.tracer = trace.getTracer(instrumentingModuleName);\n  }\n\n  /**\n   * Set a new tracer provider. This updates the underlying tracer instance.\n   * @param provider - The new tracer provider to use\n   */\n  setProvider(provider: TracerProvider): void {\n    this.tracerProvider = provider;\n    this.tracer = this.tracerProvider.getTracer(this.instrumentingModuleName);\n  }\n\n  /**\n   * Get the underlying OpenTelemetry tracer.\n   * Use this to access the full Tracer API when needed.\n   */\n  getTracer(): Tracer {\n    return this.tracer;\n  }\n\n  /**\n   * Start a span manually (without making it active).\n   * You must call span.end() when done.\n   *\n   * @param options - Span configuration including name\n   * @returns The created span\n   */\n  startSpan(options: StartSpanOptions): Span {\n    const ctx = options.context || otelContext.active();\n    const span = this.tracer.startSpan(\n      options.name,\n      {\n        attributes: options.attributes,\n      },\n      ctx,\n    );\n\n    return span;\n  }\n\n  /**\n   * Start a new span and make it active in the current context.\n   * The span will automatically be ended when the provided function completes (unless endOnExit=false).\n   *\n   * @param fn - The function to execute within the span context\n   * @param options - Span configuration including name\n   * @returns The result of the provided function\n   */\n  async startActiveSpan<T>(fn: (span: Span) => Promise<T>, options: StartSpanOptions): Promise<T> {\n    const ctx = options.context || otelContext.active();\n    const endOnExit = options.endOnExit === undefined ? true : options.endOnExit; // default true\n    const opts: SpanOptions = { attributes: options.attributes };\n\n    return new Promise((resolve, reject) => {\n      this.tracer.startActiveSpan(options.name, opts, ctx, async (span) => {\n        try {\n          const result = await fn(span);\n          resolve(result);\n        } catch (error) {\n          reject(error);\n        } finally {\n          if (endOnExit) {\n            span.end();\n          }\n        }\n      });\n    });\n  }\n\n  /**\n   * Synchronous version of startActiveSpan for non-async operations.\n   *\n   * @param fn - The function to execute within the span context\n   * @param options - Span configuration including name\n   * @returns The result of the provided function\n   */\n  startActiveSpanSync<T>(fn: (span: Span) => T, options: StartSpanOptions): T {\n    const ctx = options.context || otelContext.active();\n    const endOnExit = options.endOnExit === undefined ? true : options.endOnExit; // default true\n    const opts: SpanOptions = { attributes: options.attributes };\n\n    return this.tracer.startActiveSpan(options.name, opts, ctx, (span) => {\n      try {\n        return fn(span);\n      } finally {\n        if (endOnExit) {\n          span.end();\n        }\n      }\n    });\n  }\n}\n\n/**\n * The global tracer instance used throughout the agents framework.\n * This tracer can have its provider updated at runtime via setTracerProvider().\n */\nexport const tracer = new DynamicTracer('livekit-agents');\n\nclass MetadataSpanProcessor implements SpanProcessor {\n  private metadata: Attributes;\n\n  constructor(metadata: Attributes) {\n    this.metadata = metadata;\n  }\n\n  onStart(span: Span, _parentContext: Context): void {\n    span.setAttributes(this.metadata);\n  }\n\n  onEnd(_span: ReadableSpan): void {}\n\n  shutdown(): Promise<void> {\n    return Promise.resolve();\n  }\n\n  forceFlush(): Promise<void> {\n    return Promise.resolve();\n  }\n}\n\n// TODO(brian): PR4 - Add MetadataLogProcessor for structured logging\n\n// TODO(brian): PR4 - Add ExtraDetailsProcessor for structured logging\n\n/**\n * Set the tracer provider for the livekit-agents framework.\n * This should be called before agent session start if using custom tracer providers.\n *\n * @param provider - The tracer provider to use (must be a NodeTracerProvider)\n * @param options - Optional configuration with metadata property to inject into all spans\n *\n * @example\n * ```typescript\n * import { NodeTracerProvider } from '@opentelemetry/sdk-trace-node';\n * import { setTracerProvider } from '@livekit/agents/telemetry';\n *\n * const provider = new NodeTracerProvider();\n * setTracerProvider(provider, {\n *   metadata: { room_id: 'room123', job_id: 'job456' }\n * });\n * ```\n */\nexport function setTracerProvider(\n  provider: NodeTracerProvider,\n  options?: { metadata?: Attributes },\n): void {\n  if (options?.metadata) {\n    provider.addSpanProcessor(new MetadataSpanProcessor(options.metadata));\n  }\n\n  tracer.setProvider(provider);\n}\n\n/**\n * Setup OpenTelemetry tracer for LiveKit Cloud observability.\n * This configures OTLP exporters to send traces to LiveKit Cloud.\n *\n * @param options - Configuration for cloud tracer with roomId, jobId, and cloudHostname properties\n *\n * @internal\n */\nexport async function setupCloudTracer(options: {\n  roomId: string;\n  jobId: string;\n  cloudHostname: string;\n}): Promise<void> {\n  const { roomId, jobId, cloudHostname } = options;\n\n  const apiKey = process.env.LIVEKIT_API_KEY;\n  const apiSecret = process.env.LIVEKIT_API_SECRET;\n\n  if (!apiKey || !apiSecret) {\n    throw new Error('LIVEKIT_API_KEY and LIVEKIT_API_SECRET must be set for cloud tracing');\n  }\n\n  const token = new AccessToken(apiKey, apiSecret, {\n    identity: 'livekit-agents-telemetry',\n    ttl: '6h',\n  });\n  token.addObservabilityGrant({ write: true });\n\n  try {\n    const jwt = await token.toJwt();\n\n    const headers = {\n      Authorization: `Bearer ${jwt}`,\n    };\n\n    const metadata: Attributes = {\n      room_id: roomId,\n      job_id: jobId,\n    };\n\n    const resource = new Resource({\n      [ATTR_SERVICE_NAME]: 'livekit-agents',\n      room_id: roomId,\n      job_id: jobId,\n    });\n\n    // Configure OTLP exporter to send traces to LiveKit Cloud\n    const spanExporter = new OTLPTraceExporter({\n      url: `https://${cloudHostname}/observability/traces/otlp/v0`,\n      headers,\n      compression: CompressionAlgorithm.GZIP,\n    });\n\n    const tracerProvider = new NodeTracerProvider({\n      resource,\n      spanProcessors: [new MetadataSpanProcessor(metadata), new BatchSpanProcessor(spanExporter)],\n    });\n    tracerProvider.register();\n\n    // Metadata processor is already configured in the constructor above\n    setTracerProvider(tracerProvider);\n\n    // TODO(brian): PR4 - Add logger provider setup here for structured logging\n    // Similar to Python's setup: LoggerProvider, OTLPLogExporter, BatchLogRecordProcessor\n  } catch (error) {\n    console.error('Failed to setup cloud tracer:', error);\n    throw error;\n  }\n}\n"],"mappings":"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","names":["otelContext"]}